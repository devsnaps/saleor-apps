name: Build and push Docker images

on:
  push:
    branches: [ main ]
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

concurrency:
  group: build-images-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    name: Build and push images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        include:
          - app_name: saleor-app-avatax
            app_path: avatax
          - app_name: saleor-app-cms
            app_path: cms
          - app_name: saleor-app-klaviyo
            app_path: klaviyo
          - app_name: saleor-app-payment-np-atobarai
            app_path: np-atobarai
          - app_name: saleor-app-products-feed
            app_path: products-feed
          - app_name: saleor-app-search
            app_path: search
          - app_name: saleor-app-segment
            app_path: segment
          - app_name: saleor-app-smtp
            app_path: smtp
          - app_name: saleor-app-payment-stripe
            app_path: stripe

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract package name and version from tag
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        id: extract
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          PACKAGE_NAME=${TAG%@*}
          VERSION=${TAG#*@}

          echo "APP_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Docker meta
        if: ${{ github.ref == 'refs/heads/main' }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.app_path }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.title=${{ matrix.app_path }}

      - name: Build and push (main)
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.production
          push: ${{ github.event_name != 'pull_request' }}
          # Add linux/arm64 when needed; emulation can slow builds
          platforms: linux/amd64
          build-args: |
            APP_NAME=${{ matrix.app_name }}
            APP_PATH=${{ matrix.app_path }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.app_path }}
          cache-to: type=gha,mode=max,scope=${{ matrix.app_path }}

      - name: Build and push (tag)
        if: ${{ startsWith(github.ref, 'refs/tags/') && matrix.app_name == env.APP_NAME }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.production
          push: true
          platforms: linux/amd64
          build-args: |
            APP_NAME=${{ matrix.app_name }}
            APP_PATH=${{ matrix.app_path }}
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.app_path }}:${{ env.VERSION }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.title=${{ matrix.app_path }}
          cache-from: type=gha,scope=${{ matrix.app_path }}
          cache-to: type=gha,mode=max,scope=${{ matrix.app_path }}
